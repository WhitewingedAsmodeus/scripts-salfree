(function() {
    // Helper to wait
    function timeout(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    // Wait until Saltfree is ready
    function waitForO884(callback) {
        const check = setInterval(() => {
            if (ig.game && ig.game.O884 && typeof ig.game.O884.say === "function") {
                clearInterval(check);
                callback();
            }
        }, 100);
    }

    waitForO884(() => {
        // Text buffer for voice phrases
        const textBuffer = [];

        // Typing function
        async function slowTypeText(text, delay = 50) {
            if (!text) return; // safety
            for (let i = 0; i < text.length; i++) {
                const char = text.charAt(i);
                if (char) {
                    ig.game.O884.say("_s" + char);
                }
                if ((i + 1) % 20 === 0 && (char === " " || char === "~")) {
                    ig.game.O884.say("_nl");
                }
                await timeout(delay);
            }
            ig.game.O884.say("_nl"); // newline at end
        }

        // Setup voice recognition if available
        if ('webkitSpeechRecognition' in window) {
            const recognition = new webkitSpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = false;

            recognition.onresult = function(event) {
                const lastResult = event.results[event.results.length - 1];
                const transcript = lastResult?.[0]?.transcript?.trim();
                if (transcript) {
                    textBuffer.push(transcript);
                }
            };

            recognition.onerror = function() {}; // silently ignore
            recognition.onend = function() { recognition.start(); }; // auto-restart
            recognition.start();
        }

        // Process buffer without console output
        setInterval(() => {
            if (textBuffer.length > 0) {
                const phrase = textBuffer.shift();
                if (phrase) slowTypeText(phrase);
            }
        }, 100);

        // Optional: type a static message to test
        // slowTypeText("Test message to ensure typing works");
    });
})();

